<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - LUNAIRE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .font-playfair { font-family: 'Playfair Display', serif; }
        .font-inter { font-family: 'Inter', sans-serif; }
        .font-lunaire { font-family: 'Playfair Display', serif; font-weight: 500; }
        .dropdown-menu { transform: translateX(-100%); transition: transform 0.3s ease-in-out; }
        .dropdown-menu.open { transform: translateX(0); }
        .overlay { opacity: 0; visibility: hidden; transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out; }
        .overlay.open { opacity: 1; visibility: visible; }
    </style>
</head>
<body class="bg-gray-50 font-inter">

    <header class="relative bg-white border-b border-gray-200 z-50">
        <div class="flex items-center px-4 md:px-6 py-4">
            <button id="menuToggle" class="flex flex-col space-y-1.5 p-2 md:p-3 hover:bg-gray-100 rounded-md transition-colors mr-3 md:mr-6">
                <span class="w-6 md:w-7 h-0.5 bg-black transition-all"></span>
                <span class="w-6 md:w-7 h-0.5 bg-black transition-all"></span>
                <span class="w-6 md:w-7 h-0.5 bg-black transition-all"></span>
            </button>
            <a href="Homepage.html" class="flex-1">
                <h1 class="font-lunaire text-3xl md:text-4xl text-black tracking-wide cursor-pointer">LUNAIRE</h1>
            </a>
            <div id="searchBar" class="hidden absolute left-0 right-0 top-full bg-white px-4 py-3 border-b border-gray-200 md:relative md:flex-1 md:max-w-md md:mx-4 md:border-0 md:p-0">
                <div class="relative">
                    <input type="text" id="searchInput" placeholder="Search products..." class="w-full border border-gray-300 rounded-md px-4 py-2 pr-10 focus:outline-none focus:ring-2 focus:ring-black text-base">
                </div>
            </div>
            <div class="flex items-center space-x-2 md:space-x-4">
                <button id="searchToggle" class="p-2 hover:bg-gray-100 rounded-full transition-colors">
                    <i class="fas fa-search text-black text-lg md:text-xl"></i>
                </button>
                <button class="p-2 hover:bg-gray-100 rounded-full transition-colors">
                    <i class="fas fa-user text-black text-lg md:text-xl"></i>
                </button>
                <button class="p-2 hover:bg-gray-100 rounded-full transition-colors relative">
                    <i class="fas fa-shopping-bag text-black text-lg md:text-xl"></i>
                    <span id="headerCartCount" class="absolute -top-1 -right-1 bg-black text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">0</span>
                </button>
            </div>
        </div>
    </header>

    <div id="overlay" class="overlay fixed inset-0 bg-black bg-opacity-50 z-40"></div>
    <nav id="dropdownMenu" class="dropdown-menu fixed left-0 top-0 h-full w-80 bg-white shadow-2xl z-50 overflow-y-auto">
        <div class="p-6">
            <div class="mb-8"><h2 class="font-lunaire text-xl text-black tracking-wide">LUNAIRE</h2></div>
            <ul class="space-y-4">
                <li><a href="Homepage.html" class="block text-gray-700 hover:text-black font-medium">Home</a></li>
                <li>
                    <button class="flex justify-between items-center w-full text-gray-700 hover:text-black font-medium submenu-btn">
                        Shop <span class="transform transition-transform">â–¾</span>
                    </button>
                    <ul class="ml-4 mt-2 space-y-2 hidden submenu">
                        <li><a href="AfterShp.html" class="block text-gray-500 hover:text-black">Collection Name</a></li>
                    </ul>
                </li>
                <li><a href="faq.html" class="block text-gray-700 hover:text-black font-medium">FAQs</a></li>
            </ul>
        </div>
    </nav>

    <main class="max-w-4xl mx-auto py-12 px-4">
        <h1 class="font-playfair text-4xl mb-8 text-center font-bold">Checkout</h1>
        
        <form id="checkoutForm" class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div class="bg-white p-6 rounded-xl shadow-sm space-y-4 border border-gray-100">
                <h2 class="text-xl font-bold mb-4">Shipping Information</h2>
                <input type="text" id="custName" placeholder="Full Name" required class="w-full border p-3 rounded focus:ring-2 focus:ring-black outline-none">
                <input type="email" id="custEmail" placeholder="Email Address" required class="w-full border p-3 rounded focus:ring-2 focus:ring-black outline-none">
                <input type="tel" id="custPhone" placeholder="Phone Number" required class="w-full border p-3 rounded focus:ring-2 focus:ring-black outline-none">
                <input type="text" id="custAddress" placeholder="Street Address" required class="w-full border p-3 rounded focus:ring-2 focus:ring-black outline-none">
                <input type="text" id="custCity" placeholder="City" required class="w-full border p-3 rounded focus:ring-2 focus:ring-black outline-none">
            </div>

            <div class="bg-white p-6 rounded-xl shadow-sm h-fit border border-gray-100">
                <h2 class="text-xl font-bold mb-4">Your Order</h2>
                <div id="orderReview" class="mb-4 text-sm text-gray-600 space-y-2">
                    </div>
                <div class="border-t pt-4 mb-6">
                    <div class="flex justify-between font-bold text-lg">
                        <span>Total to Pay:</span>
                        <span id="finalTotal">PKR 0</span>
                    </div>
                    <p class="text-xs text-gray-400 mt-1">*Includes PKR 200 delivery</p>
                </div>
                <button type="submit" id="submitOrder" class="w-full bg-black text-white py-4 rounded-lg font-bold hover:bg-gray-800 transition-all">
                    PLACE ORDER
                </button>
            </div>
        </form>
    </main>

    <div id="footer"></div>

    <script>
        // 1. Logic for Header (Menu & Search)
        const menuToggle = document.getElementById("menuToggle");
        const dropdownMenu = document.getElementById("dropdownMenu");
        const overlay = document.getElementById("overlay");
        const searchToggle = document.getElementById("searchToggle");
        const searchBar = document.getElementById("searchBar");

        menuToggle.addEventListener("click", () => {
            dropdownMenu.classList.add("open");
            overlay.classList.add("open");
        });

        overlay.addEventListener("click", () => {
            dropdownMenu.classList.remove("open");
            overlay.classList.remove("open");
        });

        searchToggle.addEventListener("click", () => {
            searchBar.classList.toggle("hidden");
        });

        document.querySelectorAll(".submenu-btn").forEach((btn) => {
            btn.addEventListener("click", () => {
                const submenu = btn.nextElementSibling;
                submenu.classList.toggle("hidden");
                btn.querySelector("span").classList.toggle("rotate-180");
            });
        });

        // 2. Checkout Logic
        const cartItems = JSON.parse(localStorage.getItem('cartItems') || '[]');
        const orderReview = document.getElementById('orderReview');
        const headerCartCount = document.getElementById('headerCartCount');

        // Render Order Review & Calculate Total
        let subtotal = 0;
        let totalQty = 0;
        
        if(cartItems.length > 0) {
            orderReview.innerHTML = cartItems.map(item => {
                subtotal += (item.price * item.quantity);
                totalQty += item.quantity;
                return `<div class="flex justify-between">
                            <span>${item.name} (x${item.quantity})</span>
                            <span>PKR ${(item.price * item.quantity).toLocaleString()}</span>
                        </div>`;
            }).join('');
        }
        
        document.getElementById('finalTotal').textContent = `PKR ${(subtotal + 200).toLocaleString()}`;
        if(headerCartCount) headerCartCount.textContent = totalQty;

        // Form Submission
        document.getElementById('checkoutForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitOrder');
            btn.disabled = true;
            btn.textContent = "Processing...";

            const customerData = {
                name: document.getElementById('custName').value,
                email: document.getElementById('custEmail').value,
                phone: document.getElementById('custPhone').value,
                address: document.getElementById('custAddress').value,
                city: document.getElementById('custCity').value,
                orders: cartItems.map(item => ({
                    productId: item.id,
                    name: item.name,
                    size: item.size,
                    quantity: item.quantity,
                    price: item.price
                }))
            };

            try {
                const response = await fetch('http://localhost:4000/api/customers', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(customerData)
                });

                if (response.ok) {
                    alert('Order Placed Successfully!');
                    localStorage.removeItem('cartItems');
                    window.location.href = 'Homepage.html';
                } else {
                    const error = await response.json();
                    alert('Error: ' + error.error);
                }
            } catch (err) {
                alert('Server is not responding.');
            } finally {
                btn.disabled = false;
                btn.textContent = "PLACE ORDER";
            }
        });

        // Load Footer
        fetch("footer.html")
            .then(res => res.text())
            .then(data => { document.getElementById("footer").innerHTML = data; })
            .catch(err => console.error("Footer error:", err));
    </script>
</body>
</html>